<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>jsTree 문서 트리 (1뎁스 화살표만)</title>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- jsTree -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jstree@3.3.16/dist/themes/default/style.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/jstree@3.3.16/dist/jstree.min.js"></script>

  <style>
    body {
      margin: 24px;
      font-family: system-ui, -apple-system, "Noto Sans KR", sans-serif;
      color: #111;
    }
    .tree-wrap {
      width: 340px;
    }

    /* -----------------------------
      1) "아이콘" 전부 제거 (폴더/파일 그림)
    ------------------------------*/
    #docTree .jstree-icon.jstree-themeicon {
      display: none !important;
    }

    /* -----------------------------
      2) 선택된 줄 배경 (스크린샷 느낌)
      - wholerow 플러그인 사용
    ------------------------------*/
    #docTree .jstree-wholerow-clicked {
      background: #ffe7dc !important;
    }
    #docTree .jstree-default .jstree-clicked {
      background: transparent !important;
      box-shadow: none !important;
    }

    /* -----------------------------
      3) 텍스트(코드 + 타이틀) 한 줄 정렬
    ------------------------------*/
    #docTree .node-text {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      vertical-align: middle;
    }
    #docTree .node-code {
      font-weight: 800;
      letter-spacing: .2px;
      width: 56px;              /* 코드 칸 고정 */
      flex: 0 0 56px;
      color: #111;
    }
    #docTree .node-title {
      color: #222;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 240px;
    }

    /* -----------------------------
      4) 폴더는 체크박스 숨기기
      - li_attr.class = "is-folder"
    ------------------------------*/
    #docTree .jstree-node.is-folder > a > i.jstree-checkbox {
      display: none !important;
    }

    /* -----------------------------
      5) 체크박스 커스텀 (CSS로 모양만 변경)
    ------------------------------*/
    #docTree i.jstree-checkbox {
      background: none !important;
      width: 18px;
      height: 18px;
      position: relative;
      margin-right: 8px;
    }
    /* 박스 */
    #docTree i.jstree-checkbox::before {
      content: "";
      position: absolute;
      inset: 0;
      border: 1px solid #cfd5dd;
      border-radius: 4px;
      background: #fff;
    }
    /* 체크표시 (체크된 노드에서만) */
    #docTree .jstree-checked > a > i.jstree-checkbox::after {
      content: "";
      position: absolute;
      left: 5px;
      top: 2px;
      width: 6px;
      height: 10px;
      border-right: 2px solid #ff6a3d;
      border-bottom: 2px solid #ff6a3d;
      transform: rotate(45deg);
    }

    /* -----------------------------
      6) 화살표(ocl) 제어
      - 1뎁스 폴더에만 ▶/▼ 표시
      - 문서(leaf)는 아예 ocl 제거 (width 자리도 없게)
    ------------------------------*/

    /* 기본 ocl 배경 제거 (이미지/회전 느낌 방지) */
    #docTree .jstree-ocl {
      background: none !important;
    }

    /* 문서(leaf)에는 ocl 자체 제거 -> 자리 안 남음 */
    #docTree .jstree-leaf > .jstree-ocl {
      display: none !important;
    }

    /* 2뎁스 이상 폴더에도 화살표 안 나오게 (보험) */
    #docTree ul ul .jstree-ocl {
      display: none !important;
    }

    /* 1뎁스 폴더 ocl만 다시 살려서 화살표를 직접 그림 */
    #docTree > ul > li.jstree-node.is-folder > .jstree-ocl {
      display: inline-block !important; /* 위의 ul ul display:none 영향 방지 */
      width: 18px;
      height: 18px;
      position: relative;
      cursor: pointer;
    }

    /* 닫힘: ▶ */
    #docTree > ul > li.jstree-node.is-folder > .jstree-ocl::before {
      content: "▶";
      position: absolute;
      left: 2px;
      top: -1px;
      font-size: 12px;
      color: #333;
      line-height: 18px;
    }

    /* 열림: ▼ */
    #docTree > ul > li.jstree-node.is-folder.jstree-open > .jstree-ocl::before {
      content: "▼";
    }

    /* (선택) 화살표 hover 효과 */
    #docTree > ul > li.jstree-node.is-folder > .jstree-ocl:hover {
      background: rgba(0,0,0,0.04);
      border-radius: 4px;
    }
  </style>
</head>

<body>
  <div class="tree-wrap">
    <div id="docTree"></div>
  </div>

  <script>
    // --------------------------------------------
    // (예시) 서버에서 받는 데이터 형태
    //  - groupTitle: 1뎁스 폴더명
    //  - docs: 문서 목록 (code + title이 핵심)
    // --------------------------------------------
    const apiResponse = [
      {
        groupId: "G1",
        groupTitle: "청약서류",
        docs: [
          { code: "N1C8", title: "보험계약 청약서(단체)_202404", checked: true },
          { code: "N1C7", title: "보험계약 청약서(부활)_202404", checked: false }
        ]
      },
      {
        groupId: "G2",
        groupTitle: "계약서류",
        docs: []
      },
      {
        groupId: "G3",
        groupTitle: "공통서류",
        docs: [
          { code: "N1F8", title: "신분증", checked: false },
          { code: "N1G0", title: "주민등록증", checked: false },
          { code: "N1G0", title: "사업자등록증", checked: false }, // 코드 중복 가능 예시
          { code: "N1D8", title: "인감증명서", checked: false },
          { code: "N1E8", title: "통장사본", checked: false }
        ]
      }
    ];

    // HTML 이스케이프 (서버 데이터가 text에 들어가므로 안전장치)
    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    // API 응답 -> jsTree data 변환
    function toJsTreeData(groups) {
      return groups.map(g => {
        const folderId = "folder_" + g.groupId;

        return {
          id: folderId,
          text: escapeHtml(g.groupTitle),
          state: { opened: true },
          li_attr: { class: "is-folder" }, // 1뎁스 화살표/체크박스 제어용
          icon: false,
          children: (g.docs || []).map((d, idx) => {
            const safeCode = escapeHtml(d.code);
            const safeTitle = escapeHtml(d.title);

            return {
              // 코드 중복 대비: group + index 섞어서 유니크 보장
              id: `doc_${g.groupId}_${idx}`,
              text: `
                <span class="node-text">
                  <span class="node-code">${safeCode}</span>
                  <span class="node-title">${safeTitle}</span>
                </span>
              `,
              icon: false,
              state: { selected: !!d.checked },
              originalData: { code: d.code, title: d.title, groupId: g.groupId }
            };
          })
        };
      });
    }

    // jsTree 생성
    const $tree = $("#docTree");

    $tree.jstree({
      core: {
        data: toJsTreeData(apiResponse),
        themes: { dots: false }
      },
      plugins: ["checkbox", "wholerow"],
      checkbox: {
        keep_selected_style: false,
        tie_selection: true,  // selected == checked
        three_state: false,
        cascade: "down"
      }
    });

    // 체크된 문서 목록 가져오기
    $tree.on("changed.jstree", function (e, data) {
      const inst = data.instance;

      const checkedNodes = inst.get_checked(true);
      const docs = checkedNodes
        .filter(n => !n.li_attr?.class?.includes("is-folder"))
        .map(n => n.original.originalData);

      console.log("체크된 문서들:", docs);
      // 예: [{code:"N1C8", title:"...", groupId:"G1"}, ...]
    });

    // (예시) 실제 통신으로 교체할 때
    // function loadFromServer() {
    //   $.ajax({
    //     url: "/api/docs/tree",
    //     method: "GET",
    //     dataType: "json"
    //   }).done(function (res) {
    //     const inst = $tree.jstree(true);
    //     inst.settings.core.data = toJsTreeData(res);
    //     inst.refresh();
    //   });
    // }
  </script>
</body>
</html>
